import telebot
import random
import json
import os
import requests
import base64
import time
from flask import Flask, request
from telebot.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
TOKEN = os.environ["TOKEN"]
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY")
bot = telebot.TeleBot(TOKEN)
app = Flask(__name__)

# –•—Ä–∞–Ω–∏–ª–∏—â–∞
user_sessions = {}
last_images = {}
last_cards = {}  # –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–∞—Ä—Ç—ã –∏–ª–∏ —Ç–µ–∫—Å—Ç–∞

# –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç –∏–∑ JSON
def load_cards(filename):
    try:
        with open(filename, "r", encoding="utf-8") as f:
            return json.load(f)
    except:
        return []

# –ú–µ–Ω—é
main_menu = ReplyKeyboardMarkup(resize_keyboard=True)
main_menu.add(
    KeyboardButton("üîÆ –ü–æ—Å–ª–∞–Ω–∏–µ –¥–Ω—è"),
    KeyboardButton("üîî –°–æ–≤–µ—Ç"),
    KeyboardButton("üìö –ö–æ–ª–æ–¥—ã"),
    KeyboardButton("üß† –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ"),
    KeyboardButton("üé≤ –î–∞/–ù–µ—Ç")
)

deck_menu = ReplyKeyboardMarkup(resize_keyboard=True)
deck_menu.add(
    KeyboardButton("üßø –ê—Ä—Ö–µ—Ç–∏–ø—ã"),
    KeyboardButton("ü™∂ –ú—É–¥—Ä–æ—Å—Ç—å"),
    KeyboardButton("üåÄ –ü—Ä–æ—Ü–µ—Å—Å—ã"),
    KeyboardButton("üêæ –ü–æ—Å–ª–∞–Ω–∏—è –∑–≤–µ—Ä–µ–π"),
    KeyboardButton("üêÖ –ñ–∏–≤–æ—Ç–Ω—ã–µ —Å–∏–ª—ã"),
    KeyboardButton("üßö –°–∫–∞–∑–æ—á–Ω—ã–µ –≥–µ—Ä–æ–∏"),
    KeyboardButton("üéØ –§–æ–∫—É—Å –≤–Ω–∏–º–∞–Ω–∏—è"),
    KeyboardButton("üß± –ü—Ä–∏—á–∏–Ω—ã"),
    KeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥")
)

reason_menu = ReplyKeyboardMarkup(resize_keyboard=True)
reason_menu.add(
    KeyboardButton("üî• –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è"),
    KeyboardButton("üò± –°—Ç—Ä–∞—Ö–∏"),
    KeyboardButton("üí´ –†–∞–∑—Ä–µ—à–µ–Ω–∏—è"),
    KeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥")
)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ–ª–æ–¥
DECKS = {
    "üßø –ê—Ä—Ö–µ—Ç–∏–ø—ã": "cards.json",
    "ü™∂ –ú—É–¥—Ä–æ—Å—Ç—å": "wise_cards.json",
    "üåÄ –ü—Ä–æ—Ü–µ—Å—Å—ã": "processes.json",
    "üêæ –ü–æ—Å–ª–∞–Ω–∏—è –∑–≤–µ—Ä–µ–π": "wise_animales.json",
    "üêÖ –ñ–∏–≤–æ—Ç–Ω—ã–µ —Å–∏–ª—ã": "power_animals.json",
    "üßö –°–∫–∞–∑–æ—á–Ω—ã–µ –≥–µ—Ä–æ–∏": "fairytale_heroes.json",
    "üéØ –§–æ–∫—É—Å –≤–Ω–∏–º–∞–Ω–∏—è": "focus_cards.json"
}

REASONS = {
    "üî• –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è": ("transformation.json", "üî• –ù–µ–æ–±—Ö–æ–¥–∏–º–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è"),
    "üò± –°—Ç—Ä–∞—Ö–∏": ("fears.json", "üò± –¢–≤–æ–π —Å—Ç—Ä–∞—Ö"),
    "üí´ –†–∞–∑—Ä–µ—à–µ–Ω–∏—è": ("blessings.json", "üí´ –¢–≤–æ—ë —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ")
}

TEXT_DECKS = ["transformation.json", "fears.json", "blessings.json"]

# Deck-specific messages
DECK_SPECIFIC_MESSAGES = {
    "üßø –ê—Ä—Ö–µ—Ç–∏–ø—ã": "–≠—Ç–∞ —Ñ–∏–≥—É—Ä–∞ –ø—Ä–æ—à–ª–∞ (–∏–ª–∏ –ø—Ä–æ–∂–∏–≤–∞–µ—Ç) –∫–∞–∫–æ–π-—Ç–æ –∂–∏–∑–Ω–µ–Ω–Ω—ã–π –æ–ø—ã—Ç –∏ —Ö–æ—á–µ—Ç –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å —Ç–æ–±–æ–π —á–µ–º-—Ç–æ –≤–∞–∂–Ω—ã–º‚Ä¶. –ü—Ä–∏—Å–ª—É—à–∞–π—Å—è. –ö–∞–∫–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ –æ–Ω–∞ —Ç–µ–±–µ –Ω–µ—Å–µ—Ç? –ß—Ç–æ —Ö–æ—á–µ—Ç —Å–∫–∞–∑–∞—Ç—å? –ù–∞ —á—Ç–æ –æ–±—Ä–∞—â–∞–µ—Ç —Ç–≤–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ?",
    "üßö –°–∫–∞–∑–æ—á–Ω—ã–µ –≥–µ—Ä–æ–∏": "–≠—Ç–∞ —Ñ–∏–≥—É—Ä–∞ –ø—Ä–æ—à–ª–∞ (–∏–ª–∏ –ø—Ä–æ–∂–∏–≤–∞–µ—Ç) –∫–∞–∫–æ–π-—Ç–æ –∂–∏–∑–Ω–µ–Ω–Ω—ã–π –æ–ø—ã—Ç –∏ —Ö–æ—á–µ—Ç –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å —Ç–æ–±–æ–π —á–µ–º-—Ç–æ –≤–∞–∂–Ω—ã–º‚Ä¶. –ü—Ä–∏—Å–ª—É—à–∞–π—Å—è. –ö–∞–∫–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ –æ–Ω–∞ —Ç–µ–±–µ –Ω–µ—Å–µ—Ç? –ß—Ç–æ —Ö–æ—á–µ—Ç —Å–∫–∞–∑–∞—Ç—å? –ù–∞ —á—Ç–æ –æ–±—Ä–∞—â–∞–µ—Ç —Ç–≤–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ?",
    "üéØ –§–æ–∫—É—Å –≤–Ω–∏–º–∞–Ω–∏—è": "–≠—Ç–æ –ø–æ—Å–ª–∞–Ω–∏–µ –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–æ–º, —á—Ç–æ–±—ã —Ç—ã —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏–ª —Å–≤–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —ç—Ç–æ–π —Ç–µ–º–µ. –≠—Ç–æ —Ñ–æ–∫—É—Å –≤–Ω–∏–º–∞–Ω–∏—è. –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —ç—Ç–æ –≤ —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏. –ö–∞–∫ –æ–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ –Ω–µ–π? –ö–∞–∫ –≤–ª–∏—è–µ—Ç? –ö–∞–∫–æ–≤–æ –ø–æ—Å–ª–∞–Ω–∏–µ —ç—Ç–æ–π –∫–∞—Ä—Ç—ã?",
    "üåÄ –ü—Ä–æ—Ü–µ—Å—Å—ã": "–ù–∞ —ç—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ç–µ–±–µ —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ. –ö–∞–∫ –æ–Ω –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏? –ö–∞–∫–æ–≤–æ –µ–≥–æ –≤–ª–∏—è–Ω–∏–µ? –ö–∞–∫–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ —á–µ—Ä–µ–∑ —ç—Ç—É –∫–∞—Ä—Ç—É —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å?",
    "üêæ –ü–æ—Å–ª–∞–Ω–∏—è –∑–≤–µ—Ä–µ–π": "–ö–∞–∫–æ–µ –æ—â—É—â–µ–Ω–∏–µ —É —Ç–µ–±—è –≤–æ–∑–Ω–∏–∫–∞–µ—Ç, –∫–æ–≥–¥–∞ —Ç—ã —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ —ç—Ç–æ –∂–∏–≤–æ—Ç–Ω–æ–µ, –Ω–∞ —Ç–µ–∫—Å—Ç –∫–∞—Ä—Ç—ã? –ö–∞–∫ —ç—Ç–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏? –ö–∞–∫–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ —Ç–µ–±–µ –æ–Ω–æ –Ω–µ—Å–µ—Ç?",
    "üêÖ –ñ–∏–≤–æ—Ç–Ω—ã–µ —Å–∏–ª—ã": "–ö–∞–∫–æ–µ –æ—â—É—â–µ–Ω–∏–µ —É —Ç–µ–±—è –≤–æ–∑–Ω–∏–∫–∞–µ—Ç, –∫–æ–≥–¥–∞ —Ç—ã —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ —ç—Ç–æ –∂–∏–≤–æ—Ç–Ω–æ–µ, –Ω–∞ —Ç–µ–∫—Å—Ç –∫–∞—Ä—Ç—ã? –ö–∞–∫ —ç—Ç–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏? –ö–∞–∫–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ —Ç–µ–±–µ –æ–Ω–æ –Ω–µ—Å–µ—Ç?",
    "ü™∂ –ú—É–¥—Ä–æ—Å—Ç—å": "–ö–∞–∫–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ –¥–ª—è —Ç–µ–±—è –Ω–µ—Å–µ—Ç —ç—Ç–∞ –ø—Ä–∏—Ç—á–∞? –ö–∞–∫ —ç—Ç–∞ –º—É–¥—Ä–æ—Å—Ç—å –º–æ–∂–µ—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ —Ç–≤–æ—é –∂–∏–∑–Ω—å?",
    "üî• –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è": "–≠—Ç–æ —Ç–æ, –Ω–∞ —á—Ç–æ —Ç–µ–±–µ –Ω–∞–¥–æ –æ–±—Ä–∞—Ç–∏—Ç—å —Å–≤–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ. –ö–∞–∫ —ç—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ç–≤–æ–µ–π –∂–∏–∑–Ω—å—é, —Å —Å–∏—Ç—É–∞—Ü–∏–µ–π? –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –≤—ã–ø–∞–ª —Ç–µ–±–µ —Å–µ–≥–æ–¥–Ω—è? –ö–∞–∫–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ —Ç–µ–±–µ –æ–Ω –Ω–µ—Å–µ—Ç?",
    "üò± –°—Ç—Ä–∞—Ö–∏": "–≠—Ç–æ —Ç–æ, –Ω–∞ —á—Ç–æ —Ç–µ–±–µ –Ω–∞–¥–æ –æ–±—Ä–∞—Ç–∏—Ç—å —Å–≤–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ. –ö–∞–∫ —ç—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ç–≤–æ–µ–π –∂–∏–∑–Ω—å—é, —Å —Å–∏—Ç—É–∞—Ü–∏–µ–π? –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –≤—ã–ø–∞–ª —Ç–µ–±–µ —Å–µ–≥–æ–¥–Ω—è? –ö–∞–∫–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ —Ç–µ–±–µ –æ–Ω –Ω–µ—Å–µ—Ç?",
    "üí´ –†–∞–∑—Ä–µ—à–µ–Ω–∏—è": "–≠—Ç–æ —Ç–æ, –Ω–∞ —á—Ç–æ —Ç–µ–±–µ –Ω–∞–¥–æ –æ–±—Ä–∞—Ç–∏—Ç—å —Å–≤–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ. –ö–∞–∫ —ç—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ç–≤–æ–µ–π –∂–∏–∑–Ω—å—é, —Å —Å–∏—Ç—É–∞—Ü–∏–µ–π? –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –≤—ã–ø–∞–ª —Ç–µ–±–µ —Å–µ–≥–æ–¥–Ω—è? –ö–∞–∫–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ —Ç–µ–±–µ –æ–Ω –Ω–µ—Å–µ—Ç?"
}

ADVICE_SPECIFIC_MESSAGES = {
    "üßø –ê—Ä—Ö–µ—Ç–∏–ø—ã": "–≠—Ç–∞ —Ñ–∏–≥—É—Ä–∞ –ø—Ä–æ—à–ª–∞ (–∏–ª–∏ –ø—Ä–æ–∂–∏–≤–∞–µ—Ç) –∫–∞–∫–æ–π-—Ç–æ –∂–∏–∑–Ω–µ–Ω–Ω—ã–π –æ–ø—ã—Ç, –∏–º–µ–µ—Ç —Å–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –∏—Å—Ç–æ—Ä–∏—é –∏ –æ–Ω–∞ —Ö–æ—á–µ—Ç –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å —Ç–æ–±–æ–π —á–µ–º-—Ç–æ –≤–∞–∂–Ω—ã–º‚Ä¶. –ü—Ä–∏—Å–ª—É—à–∞–π—Å—è. –ö–∞–∫–æ–π —Å–æ–≤–µ—Ç –æ–Ω–∞ —Ç–µ–±–µ –¥–∞–µ—Ç? –í —Ç–≤–æ–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏ —á—Ç–æ –æ–Ω–∞ —Ç–µ–±–µ —Å–æ–≤–µ—Ç—É–µ—Ç –¥–µ–ª–∞—Ç—å –∏–ª–∏ –Ω–µ –¥–µ–ª–∞—Ç—å?",
    "üßö –°–∫–∞–∑–æ—á–Ω—ã–µ –≥–µ—Ä–æ–∏": "–≠—Ç–∞ —Ñ–∏–≥—É—Ä–∞ –ø—Ä–æ—à–ª–∞ (–∏–ª–∏ –ø—Ä–æ–∂–∏–≤–∞–µ—Ç) –∫–∞–∫–æ–π-—Ç–æ –∂–∏–∑–Ω–µ–Ω–Ω—ã–π –æ–ø—ã—Ç, –∏–º–µ–µ—Ç —Å–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –∏—Å—Ç–æ—Ä–∏—è –∏ –æ–Ω–∞ —Ö–æ—á–µ—Ç –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å —Ç–æ–±–æ–π —á–µ–º-—Ç–æ –≤–∞–∂–Ω—ã–º‚Ä¶. –ü—Ä–∏—Å–ª—É—à–∞–π—Å—è. –ö–∞–∫–æ–π —Å–æ–≤–µ—Ç –æ–Ω–∞ —Ç–µ–±–µ –¥–∞–µ—Ç? –í —Ç–≤–æ–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏ —á—Ç–æ –æ–Ω–∞ —Ç–µ–±–µ —Å–æ–≤–µ—Ç—É–µ—Ç –¥–µ–ª–∞—Ç—å –∏–ª–∏ –Ω–µ –¥–µ–ª–∞—Ç—å?",
    "üéØ –§–æ–∫—É—Å –≤–Ω–∏–º–∞–Ω–∏—è": "–≠—Ç–∞ –∫–∞—Ä—Ç–∞ —Å–æ–≤–µ—Ç—É–µ—Ç —Ç–µ–±–µ
